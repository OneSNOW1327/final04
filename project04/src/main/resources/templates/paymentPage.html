<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" layout:decorate="~{layout}">
    <div class="container my-3" layout:fragment="content">
        <h1>주문서 작성</h1>
        <form id="orderForm" action="/product/requestPay" method="post">
            <h4>주문상품</h4>
            <span th:text="'주문상품 (' + ${#lists.size(expectPay)} + ')'"></span>
            <input type="hidden" th:value="${#lists.size(expectPay)}" id="size">
            <table>
                <tr>
                    <th>상품사진</th>
                    <th>상품명</th>
                    <th>원가</th>
                    <th>할인금액</th>
                    <th>할인적용금액</th>
                    <th>수량</th>
                </tr>
                <tr th:each="basketPay,loop : ${expectPay}">
                    <td><img th:src="|/file/display?folder=thumbnails&filename=${basketPay.product.thumbnail[0].sysname}|" style="max-width: 50px;"></td>
                    <td><input th:id="|name_${loop.index}|" type="text" name="products[${loop.index}].name" readonly th:value="${basketPay.product.name}" /></td>
                    <td><input th:id="|sellPrice_${loop.index}|" type="text" name="products[${loop.index}].sellPrice" readonly th:value="${basketPay.product.sellPrice}" /></td>
                    <td><input th:id="|discount_${loop.index}|" type="text" name="products[${loop.index}].discount" readonly th:value="${basketPay.product.sellPrice * (basketPay.product.discount / 100)}" /></td>
                    <td><input th:id="|payPrice_${loop.index}|" type="text" name="products[${loop.index}].payPrice" readonly th:value="${basketPay.product.sellPrice * (1 - basketPay.product.discount / 100)}" /></td>
                    <td><input th:id="|quantity_${loop.index}|" type="text" name="products[${loop.index}].quantity" readonly th:value="${basketPay.quantity}" /></td>
                    <input type="hidden" name="basketId" th:value="${basketPay.id}">
                </tr>
            </table>
            <hr>
            <h4>배송지 정보</h4>
            <input type="checkbox" id="sameDelivery"><span> 주문자 정보와 동일</span>
            <table>
                <tr>
                    <th>받으시는분</th>
                    <td><input type="text" id="realName" name="receiveName"></td>
                </tr>
                <tr>
                    <th>전화번호</th>
                    <td><input type="text" id="phone" name="receivePhone"></td>
                </tr>
                <tr>
                    <th>주소</th>
                    <td><input type="text" id="adress" name="receiveAddress"></td>
                </tr>
                <tr>
                    <th>배송메세지</th>
                    <td><input type="text" name="memo"></td>
                </tr>
            </table>
            <div th:each="user,loop : ${principalUser}">
                <input th:id="userName" type="hidden" th:value="${user.realName}" />
                <input th:id="userPhone" type="hidden" th:value="${user.phone}" />
                <input th:id="userAdress" type="hidden" th:value="${user.adress}" />
            </div>
            <hr>
            <span>원가 </span><input id="sellPrice" readonly type="text"><span> - </span>
            <span>할인금액</span><input id="discount" readonly type="text"><span> = </span>
            <span>총 결제금액</span><input id="payPrice" readonly type="text">
            <hr>
            <h4>결제 방법 선택</h4>
            <select name="paymentOption">
                <option value="bankTransfer" th:onclick="kg_request_pay()">무통장입금</option>
                <option value="creditCard" th:onclick="kg_request_pay()">신용카드</option>
                <option value="kakaoPay" th:onclick="ka_request_pay()">카카오페이</option>
            </select>
            <br>
            <input type="button" value="결제하기" onclick="submitForm()">
        </form>
    </div>

	<th:block layout:fragment="script">    
		<script> 
// 금액 총합 계산
			var size = document.getElementById('size').value;
			var sumSellPrice = 0;
			var sumDiscount = 0;
			for (var i = 0; i < size; i++) {
				var quantity = document.getElementById('quantity_'+i).value;
				for(var j = 0;j <quantity; j++){
					sumSellPrice += parseFloat(document.getElementById('sellPrice_' + i).value) || 0;
					sumDiscount += parseFloat(document.getElementById('discount_' + i).value) || 0;
				}
			}
			document.getElementById('sellPrice').value = sumSellPrice;
			document.getElementById('discount').value = sumDiscount;
			document.getElementById('payPrice').value = sumSellPrice - sumDiscount;
		
// 배송지정보_주문자정보와 동일 체크
			var sameDeliveryCheckbox = document.getElementById('sameDelivery');
			sameDeliveryCheckbox.addEventListener('change', function() {
				var realNameInput = document.getElementById('realName');
				var phoneInput = document.getElementById('phone');
				var adressInput = document.getElementById('adress');
		
				var userName = document.getElementById('userName').value;
				var userPhone = document.getElementById('userPhone').value;
				var userAdress = document.getElementById('userAdress').value;
		
				if (this.checked) {
					realNameInput.value = userName;
					phoneInput.value = userPhone;
					adressInput.value = userAdress;
				} else {
					realNameInput.value = '';
					phoneInput.value = '';
					adressInput.value = '';
				}
			});

			var IMP = window.IMP; // 생략가능
		  	IMP.init('imp32764806'); // <-- 본인 가맹점 식별코드 삽입
		  	
//basketId 리스트로 만들고 orderForm제출
			function submitForm() {
				IMP.init('imp32764806'); //iamport 대신 자신의 "가맹점 식별코드"를 사용
				  IMP.request_pay({
				    pg: "{inicis}.{INIpayTest}",
				    pay_method: "card",
				    merchant_uid : 'merchant_'+new Date().getTime(),
				    name : '결제테스트',
				    amount : 100,
				    buyer_email : 'gaeun2323@naver.com',
				    buyer_name : '구매자',
				    buyer_tel : '010-4342-6938',
				    buyer_addr : '서울특별시 강남구 삼성동',
				    buyer_postcode : '123-456'
				  }, function (rsp) { // callback
				      if (rsp.success) {// 결제 성공 시 로직,
				          alert('결제가 완료되었습니다.');
				          const basketIds = [];
							document.querySelectorAll('input[name="basketId"]').forEach(input => {
								basketIds.push(input.value);
							});
					
							const hiddenInput = document.createElement('input');
							hiddenInput.type = 'hidden';
							hiddenInput.name = 'basketIds';
							hiddenInput.value = basketIds.join(',');
						
							const form = document.getElementById('orderForm');
							form.appendChild(hiddenInput);
						
							form.submit();       				        
				       
				      } else {// 결제 실패 시 로직,
				    	  var msg = '결제에 실패하였습니다.';
				          msg += '에러내용 : ' + rsp.error_msg;
				          alert(msg);				        
				      }
				  });
				
				
			}
		
		</script>
	<!-- JS 라이브러리를 추가 -->	
	<script src="https://cdn.iamport.kr/v1/iamport.js"></script>	
	<!-- jQuery -->
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
	<!-- iamport.payment.js -->
	<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-{SDK-최신버전}.js"></script>
	<!-- SDK Library 로드 -->
	<script src="https://cdn.iamport.kr/v1/iamport.js"></script>	
	
	</th:block>
</html>